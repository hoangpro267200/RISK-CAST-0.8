<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Results ‚Äî RISKCAST</title>
    <link rel="stylesheet" href="/static/css/results.css">
    
    <!-- Visualization CSS -->
    <link rel="stylesheet" href="/static/css/visualization/base.css">
    <link rel="stylesheet" href="/static/css/visualization/heatmap.css">
    <link rel="stylesheet" href="/static/css/visualization/network.css">
    <link rel="stylesheet" href="/static/css/visualization/timeline.css">
    <link rel="stylesheet" href="/static/css/visualization/gauge.css">
    <!-- SCI-FI Risk Visualization CSS (NEW) -->
    <link rel="stylesheet" href="/static/css/sci_fi_risk_viz.css">
</head>
<body>
    <div class="results-page">
        
        <header class="results-header">
            <div class="shipment-meta">
                <span class="shipment-id">SHP-2024-00847</span>
                <span class="route">Shanghai (CNSHA) ‚Üí Rotterdam (NLRTM)</span>
                <span class="carrier">Maersk Line</span>
                <span class="departure">ETD: Dec 28, 2024</span>
            </div>
        </header>

        <!-- SCI-FI CINEMATIC RISK VISUALIZATION (NEW) -->
        {% include "components/sci_fi_risk_viz.html" %}
        
        <!-- Original hero section (kept for fallback/compatibility) -->
        <section class="results-hero" style="display: none;">
            <div class="hero-content">
                <h1 class="hero-title">Overall Shipment Risk Assessment</h1>
                
                <div class="risk-orb-container">
                    <div class="risk-orb">
                        <div class="orb-glow"></div>
                        <div class="orb-score">
                            <span class="score-value">67</span>
                            <span class="score-label">Risk Score</span>
                        </div>
                    </div>
                    <div class="risk-level-badge moderate">Moderate Risk</div>
                </div>

                <div class="risk-layers-orbit">
                    <!-- Layer cards will be dynamically generated by resultsRenderer.js -->
                </div>

                <div class="confidence-indicator">
                    <span class="confidence-label">Model Confidence</span>
                    <div class="confidence-bar">
                        <div class="confidence-fill" style="width: 87%"></div>
                    </div>
                    <span class="confidence-value">87%</span>
                </div>
            </div>
        </section>

        <!-- RISK COMPOSITION SECTION - HIDDEN (replaced by sci-fi visualization) -->
        <section class="risk-composition" style="display: none;">
            <h2 class="section-title">Risk Composition</h2>
            
            <div class="composition-grid">
                <div class="composition-card radar-card">
                    <h3 class="card-title">Multi-Factor Risk Profile</h3>
                    <div class="radar-chart-placeholder">
                        <svg viewBox="0 0 400 400" class="radar-svg">
                            <circle cx="200" cy="200" r="160" fill="none" stroke="rgba(0, 255, 255, 0.1)" stroke-width="1"/>
                            <circle cx="200" cy="200" r="120" fill="none" stroke="rgba(0, 255, 255, 0.1)" stroke-width="1"/>
                            <circle cx="200" cy="200" r="80" fill="none" stroke="rgba(0, 255, 255, 0.1)" stroke-width="1"/>
                            <circle cx="200" cy="200" r="40" fill="none" stroke="rgba(0, 255, 255, 0.1)" stroke-width="1"/>
                            <line x1="200" y1="200" x2="200" y2="40" stroke="rgba(0, 255, 255, 0.2)" stroke-width="1"/>
                            <line x1="200" y1="200" x2="339" y2="108" stroke="rgba(0, 255, 255, 0.2)" stroke-width="1"/>
                            <line x1="200" y1="200" x2="339" y2="292" stroke="rgba(0, 255, 255, 0.2)" stroke-width="1"/>
                            <line x1="200" y1="200" x2="200" y2="360" stroke="rgba(0, 255, 255, 0.2)" stroke-width="1"/>
                            <line x1="200" y1="200" x2="61" y2="292" stroke="rgba(0, 255, 255, 0.2)" stroke-width="1"/>
                            <line x1="200" y1="200" x2="61" y2="108" stroke="rgba(0, 255, 255, 0.2)" stroke-width="1"/>
                            <polygon points="200,85 295,130 295,260 200,295 105,260 105,130" 
                                     fill="rgba(0, 255, 255, 0.2)" 
                                     stroke="rgba(0, 255, 255, 0.8)" 
                                     stroke-width="2"/>
                            <text x="200" y="30" text-anchor="middle" fill="rgba(255, 255, 255, 0.7)" font-size="12">Geopolitical</text>
                            <text x="350" y="110" text-anchor="start" fill="rgba(255, 255, 255, 0.7)" font-size="12">Weather</text>
                            <text x="350" y="295" text-anchor="start" fill="rgba(255, 255, 255, 0.7)" font-size="12">Route</text>
                            <text x="200" y="380" text-anchor="middle" fill="rgba(255, 255, 255, 0.7)" font-size="12">Cargo</text>
                            <text x="50" y="295" text-anchor="end" fill="rgba(255, 255, 255, 0.7)" font-size="12">Port</text>
                            <text x="50" y="110" text-anchor="end" fill="rgba(255, 255, 255, 0.7)" font-size="12">Carrier</text>
                        </svg>
                    </div>
                </div>

                <div class="composition-card layers-table-card">
                    <h3 class="card-title">Risk Layer Breakdown</h3>
                    <table class="layers-table">
                        <thead>
                            <tr>
                                <th>Layer</th>
                                <th>Score</th>
                                <th>Contribution</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr class="layer-row high">
                                <td><span class="layer-dot"></span> Geopolitical</td>
                                <td class="score-cell">72</td>
                                <td class="contribution-cell">
                                    <div class="contribution-bar" style="width: 24%"></div>
                                    <span>24%</span>
                                </td>
                                <td><span class="status-badge high">High</span></td>
                            </tr>
                            <tr class="layer-row moderate">
                                <td><span class="layer-dot"></span> Route</td>
                                <td class="score-cell">69</td>
                                <td class="contribution-cell">
                                    <div class="contribution-bar" style="width: 22%"></div>
                                    <span>22%</span>
                                </td>
                                <td><span class="status-badge moderate">Moderate</span></td>
                            </tr>
                            <tr class="layer-row moderate">
                                <td><span class="layer-dot"></span> Port</td>
                                <td class="score-cell">63</td>
                                <td class="contribution-cell">
                                    <div class="contribution-bar" style="width: 19%"></div>
                                    <span>19%</span>
                                </td>
                                <td><span class="status-badge moderate">Moderate</span></td>
                            </tr>
                            <tr class="layer-row moderate">
                                <td><span class="layer-dot"></span> Weather</td>
                                <td class="score-cell">58</td>
                                <td class="contribution-cell">
                                    <div class="contribution-bar" style="width: 16%"></div>
                                    <span>16%</span>
                                </td>
                                <td><span class="status-badge moderate">Moderate</span></td>
                            </tr>
                            <tr class="layer-row low">
                                <td><span class="layer-dot"></span> Cargo</td>
                                <td class="score-cell">51</td>
                                <td class="contribution-cell">
                                    <div class="contribution-bar" style="width: 11%"></div>
                                    <span>11%</span>
                                </td>
                                <td><span class="status-badge low">Low</span></td>
                            </tr>
                            <tr class="layer-row low">
                                <td><span class="layer-dot"></span> Carrier</td>
                                <td class="score-cell">45</td>
                                <td class="contribution-cell">
                                    <div class="contribution-bar" style="width: 8%"></div>
                                    <span>8%</span>
                                </td>
                                <td><span class="status-badge low">Low</span></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <section class="financial-impact">
            <h2 class="section-title">Financial Impact Analysis</h2>
            
            <div class="financial-grid">
                <div class="financial-card histogram-card">
                    <h3 class="card-title">Loss Distribution</h3>
                    <p class="card-caption">10,000 Monte Carlo simulations</p>
                    <div class="histogram-chart">
                        <svg viewBox="0 0 600 300" class="histogram-svg">
                            <line x1="50" y1="30" x2="50" y2="250" stroke="rgba(255, 255, 255, 0.3)" stroke-width="1"/>
                            <line x1="50" y1="250" x2="570" y2="250" stroke="rgba(255, 255, 255, 0.3)" stroke-width="1"/>
                            <rect x="70" y="180" width="35" height="70" fill="rgba(0, 255, 255, 0.3)"/>
                            <rect x="110" y="140" width="35" height="110" fill="rgba(0, 255, 255, 0.4)"/>
                            <rect x="150" y="100" width="35" height="150" fill="rgba(0, 255, 255, 0.5)"/>
                            <rect x="190" y="70" width="35" height="180" fill="rgba(0, 255, 255, 0.7)"/>
                            <rect x="230" y="50" width="35" height="200" fill="rgba(0, 255, 255, 0.9)"/>
                            <rect x="270" y="40" width="35" height="210" fill="rgba(0, 255, 255, 1)"/>
                            <rect x="310" y="60" width="35" height="190" fill="rgba(0, 255, 255, 0.8)"/>
                            <rect x="350" y="90" width="35" height="160" fill="rgba(0, 255, 255, 0.6)"/>
                            <rect x="390" y="130" width="35" height="120" fill="rgba(0, 255, 255, 0.5)"/>
                            <rect x="430" y="170" width="35" height="80" fill="rgba(0, 255, 255, 0.4)"/>
                            <rect x="470" y="200" width="35" height="50" fill="rgba(0, 255, 255, 0.3)"/>
                            <rect x="510" y="220" width="35" height="30" fill="rgba(0, 255, 255, 0.2)"/>
                            <text x="60" y="270" fill="rgba(255, 255, 255, 0.6)" font-size="11">$0</text>
                            <text x="270" y="270" fill="rgba(255, 255, 255, 0.6)" font-size="11">$50k</text>
                            <text x="500" y="270" fill="rgba(255, 255, 255, 0.6)" font-size="11">$100k+</text>
                        </svg>
                    </div>
                    <div class="histogram-stats">
                        <div class="stat-item">
                            <span class="stat-label">Mean Loss</span>
                            <span class="stat-value">$47,200</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Std Dev</span>
                            <span class="stat-value">$18,900</span>
                        </div>
                    </div>
                </div>

                <div class="financial-card loss-curve-card">
                    <h3 class="card-title">Cumulative Loss Curve</h3>
                    <p class="card-caption">VaR and CVaR analysis</p>
                    <div class="loss-curve-chart">
                        <svg viewBox="0 0 600 300" class="loss-curve-svg">
                            <line x1="50" y1="30" x2="50" y2="250" stroke="rgba(255, 255, 255, 0.3)" stroke-width="1"/>
                            <line x1="50" y1="250" x2="570" y2="250" stroke="rgba(255, 255, 255, 0.3)" stroke-width="1"/>
                            <path d="M 50,240 Q 150,230 250,180 T 450,80 T 570,50" 
                                  fill="none" 
                                  stroke="rgba(0, 255, 255, 0.8)" 
                                  stroke-width="3"/>
                            <line x1="400" y1="250" x2="400" y2="100" stroke="rgba(255, 184, 0, 0.8)" stroke-width="2" stroke-dasharray="4,4"/>
                            <circle cx="400" cy="100" r="5" fill="rgba(255, 184, 0, 1)"/>
                            <text x="400" y="90" text-anchor="middle" fill="rgba(255, 184, 0, 1)" font-size="11" font-weight="600">VaR 95%</text>
                            <text x="400" y="270" text-anchor="middle" fill="rgba(255, 184, 0, 0.8)" font-size="11">$72k</text>
                            <line x1="490" y1="250" x2="490" y2="65" stroke="rgba(255, 59, 48, 0.8)" stroke-width="2" stroke-dasharray="4,4"/>
                            <circle cx="490" cy="65" r="5" fill="rgba(255, 59, 48, 1)"/>
                            <text x="490" y="55" text-anchor="middle" fill="rgba(255, 59, 48, 1)" font-size="11" font-weight="600">CVaR</text>
                            <text x="490" y="270" text-anchor="middle" fill="rgba(255, 59, 48, 0.8)" font-size="11">$89k</text>
                            <text x="300" y="285" text-anchor="middle" fill="rgba(255, 255, 255, 0.5)" font-size="12">Loss Amount ($)</text>
                            <text x="25" y="150" text-anchor="middle" fill="rgba(255, 255, 255, 0.5)" font-size="12" transform="rotate(-90 25 150)">Probability</text>
                        </svg>
                    </div>
                    <div class="loss-stats">
                        <div class="stat-item var">
                            <span class="stat-label">VaR (95%)</span>
                            <span class="stat-value">$72,400</span>
                        </div>
                        <div class="stat-item cvar">
                            <span class="stat-label">CVaR (Tail)</span>
                            <span class="stat-value">$89,100</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="expected-loss-summary">
                <div class="summary-item">
                    <span class="summary-label">Expected Loss</span>
                    <span class="summary-value primary">$47,200</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">95th Percentile</span>
                    <span class="summary-value">$72,400</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">Maximum Observed</span>
                    <span class="summary-value">$103,800</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">Cargo Value</span>
                    <span class="summary-value">$850,000</span>
                </div>
            </div>
        </section>

        <section class="decision-intelligence">
            <h2 class="section-title">Insurance Decision</h2>
            
            <div class="decision-panel">
                <div class="recommendation-badge recommended">
                    <div class="badge-icon">‚úì</div>
                    <div class="badge-content">
                        <span class="badge-label">Recommendation</span>
                        <span class="badge-value">Insurance Recommended</span>
                    </div>
                </div>

                <div class="decision-cards-grid">
                    <div class="decision-card window-card">
                        <h3 class="card-title">Safe Shipping Window</h3>
                        <div class="window-content">
                            <div class="window-optimal">
                                <span class="window-label">Optimal Window</span>
                                <span class="window-dates">Jan 15 ‚Äì Jan 22, 2025</span>
                            </div>
                            <div class="window-current">
                                <span class="window-label">Current ETD</span>
                                <span class="window-dates outside">Dec 28, 2024</span>
                                <span class="window-status">Outside optimal window</span>
                            </div>
                            <div class="window-risk-reduction">
                                <span class="reduction-label">Risk reduction if delayed</span>
                                <span class="reduction-value">-18 points</span>
                            </div>
                        </div>
                    </div>

                    <div class="decision-card providers-card">
                        <h3 class="card-title">Recommended Providers</h3>
                        <div class="providers-list">
                            <div class="provider-item best-fit">
                                <div class="provider-rank">1</div>
                                <div class="provider-info">
                                    <span class="provider-name">Allianz Global</span>
                                    <span class="provider-fit">Best fit: 94%</span>
                                </div>
                                <span class="provider-premium">$4,200</span>
                            </div>
                            <div class="provider-item">
                                <div class="provider-rank">2</div>
                                <div class="provider-info">
                                    <span class="provider-name">Chubb Marine</span>
                                    <span class="provider-fit">Fit: 89%</span>
                                </div>
                                <span class="provider-premium">$4,500</span>
                            </div>
                            <div class="provider-item">
                                <div class="provider-rank">3</div>
                                <div class="provider-info">
                                    <span class="provider-name">AIG Cargo</span>
                                    <span class="provider-fit">Fit: 86%</span>
                                </div>
                                <span class="provider-premium">$4,800</span>
                            </div>
                        </div>
                    </div>

                    <div class="decision-card traceability-card">
                        <h3 class="card-title">Decision Traceability</h3>
                        <div class="trace-items">
                            <div class="trace-item">
                                <div class="trace-icon">üìä</div>
                                <div class="trace-content">
                                    <span class="trace-label">Risk Score</span>
                                    <span class="trace-detail">67/100 exceeds threshold (60)</span>
                                </div>
                            </div>
                            <div class="trace-item">
                                <div class="trace-icon">üí∞</div>
                                <div class="trace-content">
                                    <span class="trace-label">Expected Loss</span>
                                    <span class="trace-detail">$47.2k vs $4.2k premium (11:1 ratio)</span>
                                </div>
                            </div>
                            <div class="trace-item">
                                <div class="trace-icon">üéØ</div>
                                <div class="trace-content">
                                    <span class="trace-label">Coverage Gap</span>
                                    <span class="trace-detail">Current policy excludes geopolitical risk</span>
                                </div>
                            </div>
                            <div class="trace-item">
                                <div class="trace-icon">üìà</div>
                                <div class="trace-content">
                                    <span class="trace-label">ROI Projection</span>
                                    <span class="trace-detail">Positive expected value ($43k net)</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section class="ai-narrative">
            <h2 class="section-title">Risk Analysis Summary</h2>
            
            <div class="narrative-panel">
                <div class="narrative-header">
                    <div class="ai-badge">
                        <span class="ai-icon">‚ú¶</span>
                        <span>AI-Generated Analysis</span>
                    </div>
                    <span class="analysis-timestamp">Generated: Dec 19, 2024 14:32 UTC</span>
                </div>

                <div class="narrative-content">
                    <p class="narrative-summary">
                        Shanghai-Rotterdam shipment faces <strong>elevated geopolitical risk (72/100)</strong> due to Red Sea tensions affecting Suez Canal transit. Expected delays of 5-7 days may impact delivery commitments.
                    </p>

                    <div class="insights-grid">
                        <div class="insight-card critical">
                            <div class="insight-header">
                                <span class="insight-icon">‚ö†Ô∏è</span>
                                <span class="insight-label">Critical Factor</span>
                            </div>
                            <p class="insight-text">Red Sea diversions add 10-14 days via Cape of Good Hope, increasing weather exposure and fuel costs by 40%</p>
                        </div>

                        <div class="insight-card opportunity">
                            <div class="insight-header">
                                <span class="insight-icon">üí°</span>
                                <span class="insight-label">Mitigation Option</span>
                            </div>
                            <p class="insight-text">Delaying departure to mid-January reduces geopolitical risk score to 54 and aligns with optimal weather window</p>
                        </div>

                        <div class="insight-card watch">
                            <div class="insight-header">
                                <span class="insight-icon">üëÅÔ∏è</span>
                                <span class="insight-label">Monitor</span>
                            </div>
                            <p class="insight-text">Rotterdam port congestion increasing (current: 3.2 days avg dwell time). Consider alternative discharge ports if delays exceed 5 days</p>
                        </div>
                    </div>

                    <div class="action-items">
                        <h4 class="action-title">Recommended Actions</h4>
                        <ul class="action-list">
                            <li>Secure marine insurance with geopolitical coverage before Dec 22</li>
                            <li>Negotiate force majeure clause with buyer for Red Sea delays</li>
                            <li>Activate real-time tracking for Suez Canal / Cape routing decision</li>
                            <li>Review alternative carriers with dedicated Cape routes for cost optimization</li>
                        </ul>
                    </div>
                </div>

                <div class="narrative-footer">
                    <span class="methodology-link">View methodology & data sources ‚Üí</span>
                </div>
            </div>
        </section>

        <!-- Risk Visualizations Section -->
        {% include "components/risk_visualizations.html" %}

    </div>
    
    {% if summary_json %}
    <script id="riskcast-summary-data" type="application/json">{{ summary_json|safe }}</script>
    <script>
        // Inject summary data if available from server
        (function() {
            try {
                const dataScript = document.getElementById('riskcast-summary-data');
                if (dataScript) {
                    window.__RISKCAST_SUMMARY__ = JSON.parse(dataScript.textContent);
                }
            } catch (e) {
                console.warn('[Results] Failed to inject summary data:', e);
            }
        })();
    </script>
    {% endif %}
    
    <!-- Chart.js CDN (for radar, bar, timeline charts) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js" defer></script>
    
    <!-- SCI-FI Risk Visualization JavaScript (NEW) -->
    <script src="/static/js/sci_fi_risk_viz.js"></script>
    
    <!-- Visualization JavaScript (load in order) -->
    <script src="/static/js/visualization/utils.js"></script>
    <script src="/static/js/visualization/gauge.js"></script>
    <script src="/static/js/visualization/heatmap.js"></script>
    <!-- RadarChart class-based component (preferred) -->
    <script type="module">
        // Export RadarChart to global scope for integration layer
        import { RadarChart } from '/static/js/components/RadarChart.js';
        window.RadarChart = RadarChart;
        // Also expose via RISKCAST namespace
        if (typeof window.RISKCAST === 'undefined') window.RISKCAST = {};
        if (typeof window.RISKCAST.components === 'undefined') window.RISKCAST.components = {};
        window.RISKCAST.components.RadarChart = RadarChart;
    </script>
    <!-- Fallback: old function-based radar.js (for backward compatibility) -->
    <script src="/static/js/visualization/radar.js"></script>
    <script src="/static/js/visualization/drivers_bar.js"></script>
    <script src="/static/js/visualization/timeline.js"></script>
    <script src="/static/js/visualization/network_graph.js"></script>
    <script src="/static/js/visualization/results_v2_integration.js"></script>
    
    <!-- Utility Scripts (load before main.js) -->
    <script src="/static/js/utils/scenarioClassifierLoader.js"></script>
    
    <!-- Main Results Page Script -->
    <script type="module" src="/static/js/main.js"></script>
    
    <!-- Initialize Visualizations -->
    <script>
        // Initialize visualizations after page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Wait for all modules to load
            const initVisualizations = () => {
                if (window.RISKCAST && window.RISKCAST.visualization && window.RISKCAST.visualization.results) {
                    // Try to get shipment data from various sources
                    let shipmentData = null;
                    
                    // Source 1: window.__RISKCAST_SUMMARY__
                    if (window.__RISKCAST_SUMMARY__) {
                        const summary = window.__RISKCAST_SUMMARY__;
                        shipmentData = {
                            route: summary.shipment?.routeText || summary.shipment?.route || '',
                            pol: summary.shipment?.pol || '',
                            pod: summary.shipment?.pod || '',
                            cargo_value: summary.financial?.cargoValue || summary.shipment?.cargo_value || 0,
                            risk_score: summary.overall?.riskScore || summary.risk_score || 0,
                            risk_level: summary.overall?.riskLevel || summary.risk_level || 'moderate',
                            confidence: summary.overall?.confidence || 0.5,
                            layers: summary.layers || [],
                            factors: summary.factors || []
                        };
                    }
                    // Source 2: window.__RESULTSOS__
                    else if (window.__RESULTSOS__) {
                        const summary = window.__RESULTSOS__.summary || window.__RESULTSOS__.state;
                        if (summary) {
                            shipmentData = {
                                route: summary.shipment?.routeText || summary.shipment?.route || '',
                                pol: summary.shipment?.pol || '',
                                pod: summary.shipment?.pod || '',
                                cargo_value: summary.financial?.cargoValue || summary.shipment?.cargo_value || 0,
                                risk_score: summary.overall?.riskScore || summary.globalRisk || 0,
                                risk_level: summary.overall?.riskLevel || summary.decision?.riskLevel || 'moderate',
                                confidence: summary.overall?.confidence || summary.decision?.confidence || 0.5,
                                layers: summary.layers || [],
                                factors: summary.factors || []
                            };
                        }
                    }
                    
                    // Initialize visualizations (shipmentData can be null - function will fetch from API)
                    window.RISKCAST.visualization.results.initializeVisualizations(shipmentData);
                } else {
                    // Retry after a short delay
                    setTimeout(initVisualizations, 500);
                }
            };
            
            // Start initialization after a short delay to ensure all scripts are loaded
            setTimeout(initVisualizations, 100);
        });
    </script>
</body>
</html>
